<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ² ä»Šæ—¥é™å®šæŠ½ç</title>
  <style>
    :root { --w: 340px; }
    body{
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:#0b0f17; color:#e9eef7;
    }
    .wrap{ text-align:center; padding:28px 18px; width:min(520px, 92vw); }
    h2{ margin:0 0 8px; font-weight:800; letter-spacing:0.5px; }
    .sub{ opacity:.8; margin:0 0 18px; font-size:14px; }
    .stage{ position:relative; width:var(--w); height:var(--w); margin:0 auto; }
    canvas{ width:100%; height:100%; border-radius:50%; box-shadow:0 10px 40px rgba(0,0,0,.55); }
    .pointer{
      position:absolute; top:-10px; left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:26px solid #ffd166;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
    }
    .btn{
      margin-top:18px;
      background:#ffd166; color:#1b1f2a;
      border:0; border-radius:999px;
      padding:12px 20px;
      font-size:18px; font-weight:800;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(255,209,102,.22);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .result{
      margin-top:16px;
      font-size:18px; line-height:1.45;
      padding:12px 14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      display:none;
    }
    .tiny{ margin-top:10px; font-size:12px; opacity:.55; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ğŸ² ä»Šæ—¥é™å®šæŠ½ç</h2>
    <p class="sub">æŒ‰ä¸‹å»å°±ç®—æ•¸ã€‚æ‰‹æ°£ä¸å¥½ä¸è¦æ€ªæˆ‘ï¼ˆæˆ‘ä¹Ÿæ€•ï¼‰ğŸ˜¶â€ğŸŒ«ï¸</p>

    <div class="stage">
      <div class="pointer"></div>
      <canvas id="wheel" width="680" height="680"></canvas>
    </div>

    <button id="spinBtn" class="btn">é–‹å§‹æŠ½ç</button>

    <div id="result" class="result"></div>
    <div class="tiny">â€» è‹¥æ²’è½åˆ°è²éŸ³ï¼šè«‹ç¢ºèªæ‰‹æ©ŸæœªéœéŸ³ / éŸ³é‡ä¸ç‚º 0</div>
  </div>

<script>
/** ====== ä½ åªè¦æ”¹é€™å…©å€‹ ====== */

// 1) çå“æ¸…å–®ï¼ˆä½ è¦ä»€éº¼å°±æ”¾ä»€éº¼ï¼‰
const prizes = [
  "ğŸ è«‹å¦³å–ä¸€æ¯",
  "ğŸ æŒ‡å®šä¸€å¤©é™ªå¦³",
  "ğŸ ç¥ç§˜é©šå–œ",
  "ğŸ˜ ï¼ˆä¸‹æ¬¡å†ä¾†ï¼‰",
  "ğŸ˜ ï¼ˆæ¸¬è©¦çå‹µï¼‰"
];

// 2) å›å‚³ä½ç½®ï¼ˆDiscord Webhook / ä½ çš„å¾Œç«¯ / Apps Script URLï¼‰
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwmK2iq0buMnVpxMPLJdd4yhOvpykvZ9nKv-9RUFBI-F3rMGtSELuYLLie4OjflhAnv/exec";

/** ====== è½‰ç›¤ç¹ªè£½ ====== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;
const cx = W/2, cy = H/2;
const radius = Math.min(W,H)*0.46;

let rotation = 0; // radians
let spinning = false;

// ç”¢ç”Ÿæ¼‚äº®ä½†ç°¡å–®çš„åˆ†å€è‰²
function sliceColor(i, n){
  // ä¸æŒ‡å®šç‰¹å®šé¡è‰²ä¸»é¡Œï¼Œåšä¸€çµ„çœ‹å¾—æ¸…æ¥šçš„ HSL
  const hue = (i * (360/n)) % 360;
  return `hsl(${hue}, 70%, 45%)`;
}

function drawWheel(rot = rotation){
  ctx.clearRect(0,0,W,H);
  const n = prizes.length;
  const arc = (Math.PI * 2) / n;

  // å¤–åœˆ
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(rot);

  for(let i=0;i<n;i++){
    // sector
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius, i*arc, (i+1)*arc);
    ctx.closePath();
    ctx.fillStyle = sliceColor(i, n);
    ctx.fill();

    // åˆ†éš”ç·š
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 6;
    ctx.stroke();

    // æ–‡å­—
    ctx.save();
    ctx.rotate(i*arc + arc/2);
    ctx.textAlign = "right";
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.font = "bold 28px system-ui, -apple-system, Noto Sans TC, sans-serif";
    // æ–‡å­—å¤ªé•·å°±è£ä¸€ä¸‹ï¼ˆé¿å…çˆ†ç‰ˆï¼‰
    const label = prizes[i].length > 16 ? prizes[i].slice(0,16)+"â€¦" : prizes[i];
    ctx.fillText(label, radius - 20, 10);
    ctx.restore();
  }

  // ä¸­å¿ƒåœ“
  ctx.beginPath();
  ctx.arc(0,0,70,0,Math.PI*2);
  ctx.fillStyle = "rgba(0,0,0,.35)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  ctx.lineWidth = 8;
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,.92)";
  ctx.font = "900 26px system-ui, -apple-system, Noto Sans TC, sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("SPIN", 0, 10);

  ctx.restore();
}

// åˆå§‹ç•«é¢
drawWheel();

/** ====== éŸ³æ•ˆï¼ˆWeb Audioï¼‰ ====== */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended") audioCtx.resume();
}

function beep(freq=880, duration=0.03, type="sine", gainVal=0.06){
  ensureAudio();
  const t = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, t);
  g.gain.setValueAtTime(gainVal, t);
  g.gain.exponentialRampToValueAtTime(0.0001, t + duration);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(t); o.stop(t + duration);
}

// è½‰ç›¤ã€Œå’”å“’ã€è²ï¼šæ¯éä¸€æ ¼å°±å•µä¸€ä¸‹
function tick(){
  beep(1200, 0.02, "square", 0.05);
}

// ä¸­çå°æ—‹å¾‹
function winJingle(){
  beep(784, 0.06, "sine", 0.07);
  setTimeout(()=>beep(988, 0.06, "sine", 0.07), 80);
  setTimeout(()=>beep(1175,0.08, "sine", 0.08), 160);
}

/** ====== æŠ½çé‚è¼¯ ====== */
const btn = document.getElementById("spinBtn");
const resultEl = document.getElementById("result");

// æŒ‡é‡åœ¨æ­£ä¸Šæ–¹ï¼Œä»£è¡¨ã€Œä¸Šæ–¹æŒ‡åˆ°çš„æ‰‡å€ã€ç‚ºçµæœã€‚
// æˆ‘å€‘ç”¨è§’åº¦ç®—å‡ºåœä¸‹æ™‚æŒ‡é‡æŒ‡åˆ°ç¬¬å¹¾æ ¼ã€‚
function pickIndexFromRotation(rot){
  const n = prizes.length;
  const arc = (Math.PI*2)/n;

  // æŒ‡é‡åœ¨ -90åº¦ï¼ˆæ­£ä¸Šæ–¹ï¼‰ï¼Œè½‰ç›¤æ—‹è½‰ rot
  const pointerAngle = (-Math.PI/2 - rot) % (Math.PI*2);
  const a = (pointerAngle + Math.PI*2) % (Math.PI*2);
  const idx = Math.floor(a / arc); // 0..n-1
  return idx;
}

// é€çµæœåˆ°ä½ é‚£é‚Šï¼ˆä¸è®“å¥¹çŸ¥é“ï¼‰
async function sendResult(payload){
  if(!WEBHOOK_URL || WEBHOOK_URL.includes("YOUR_WEBHOOK_URL")) return;

  try{
    await fetch(WEBHOOK_URL, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
  }catch(e){
    // éœé»˜å¤±æ•—ï¼šåˆ¥åœ¨å¥¹é¢å‰çˆ†ç‚¸
    console.warn("Webhook failed:", e);
  }
}

// ease out
function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

btn.addEventListener("click", async () => {
  if(spinning) return;
  spinning = true;

  ensureAudio(); // iOS è¦æ±‚ï¼šç”±é»æ“Šè§¸ç™¼æ‰èƒ½å•Ÿå‹•è²éŸ³
  resultEl.style.display = "none";
  btn.disabled = true;
  btn.textContent = "æŠ½çä¸­â€¦";

  const n = prizes.length;
  const arc = (Math.PI*2)/n;

  // éš¨æ©Ÿç›®æ¨™ indexï¼ˆä½ æƒ³è¦æ§æ©Ÿç‡å°±æ”¹é€™è£¡ï¼Œä½†åˆ¥å¤ªæ˜é¡¯ ğŸ˜ï¼‰
  const targetIndex = Math.floor(Math.random() * n);

  // è®“å®ƒå¤šè½‰å¹¾åœˆ + ç²¾æº–åœåœ¨ targetIndex çš„ä¸­å¿ƒ
  const extraSpins = 6 + Math.floor(Math.random()*3); // 6~8åœˆ
  const targetAngleCenter = (targetIndex + 0.5) * arc; // æ‰‡å€ä¸­å¿ƒè§’
  // æˆ‘å€‘è¦è®“ pointerAngle = targetAngleCenter
  // pointerAngle = (-pi/2 - rot) mod 2pi
  // => rot = -pi/2 - targetAngleCenter  (mod 2pi)
  const desiredRot = (-Math.PI/2 - targetAngleCenter);
  const finalRot = desiredRot + extraSpins * Math.PI * 2;

  const startRot = rotation;
  const delta = finalRot - startRot;

  const duration = 2600 + Math.random()*900; // 2.6~3.5 ç§’
  const start = performance.now();

  let lastTickIdx = pickIndexFromRotation(rotation);

  function animate(now){
    const t = Math.min(1, (now - start)/duration);
    const eased = easeOutCubic(t);
    rotation = startRot + delta * eased;
    drawWheel(rotation);

    // tick éŸ³ï¼šæ¯è·¨éä¸€æ ¼è§¸ç™¼ä¸€æ¬¡
    const idx = pickIndexFromRotation(rotation);
    if(idx !== lastTickIdx){
      tick();
      lastTickIdx = idx;
    }

    if(t < 1){
      requestAnimationFrame(animate);
    }else{
      spinning = false;

      // æœ€çµ‚ indexï¼ˆç†è«–ä¸Š=targetIndexï¼‰
      const finalIndex = pickIndexFromRotation(rotation);
      const prize = prizes[finalIndex];

      winJingle();

      resultEl.textContent = `âœ… ä½ æŠ½åˆ°ï¼š${prize}`;
      resultEl.style.display = "block";
      btn.disabled = false;
      btn.textContent = "å†æŠ½ä¸€æ¬¡ï¼ˆä¸å»ºè­°å¤ªè²ªå¿ƒï¼‰";

      // å›å‚³çµæœçµ¦ä½ 
      sendResult({
        prize,
        index: finalIndex,
        time: new Date().toISOString(),
        userAgent: navigator.userAgent
      });
    }
  }

  requestAnimationFrame(animate);
});
</script>
</body>
</html>