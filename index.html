<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ² ä»Šæ—¥é™å®šæŠ½ç</title>
  <style>
    :root { --w: 340px; }
    body{
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:#0b0f17; color:#e9eef7;
    }
    .wrap{ text-align:center; padding:28px 18px; width:min(520px, 92vw); }
    h2{ margin:0 0 8px; font-weight:800; letter-spacing:0.5px; }
    .sub{ opacity:.8; margin:0 0 18px; font-size:14px; }
    .stage{ position:relative; width:var(--w); height:var(--w); margin:0 auto; }
    canvas{ width:100%; height:100%; border-radius:50%; box-shadow:0 10px 40px rgba(0,0,0,.55); }
    .pointer{
      position:absolute; top:-10px; left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:26px solid #ffd166;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
    }
    .btn{
      margin-top:18px;
      background:#ffd166; color:#1b1f2a;
      border:0; border-radius:999px;
      padding:12px 20px;
      font-size:18px; font-weight:800;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(255,209,102,.22);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .result{
      margin-top:16px;
      font-size:18px; line-height:1.45;
      padding:12px 14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      display:none;
    }
    .tiny{ margin-top:10px; font-size:12px; opacity:.55; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>ğŸ² ä»Šæ—¥é™å®šæŠ½ç</h2>
  <p class="sub">æŒ‰ä¸‹å»å°±ç®—æ•¸ã€‚æ‰‹æ°£ä¸å¥½ä¸è¦æ€ªæˆ‘ï¼ˆæˆ‘ä¹Ÿæ€•ï¼‰ğŸ˜¶â€ğŸŒ«ï¸</p>

  <div class="stage">
    <div class="pointer"></div>
    <canvas id="wheel" width="680" height="680"></canvas>
  </div>

  <button id="spinBtn" class="btn">é–‹å§‹æŠ½ç</button>

  <div id="result" class="result"></div>
  <div class="tiny">â€» è‹¥æ²’è½åˆ°è²éŸ³ï¼šè«‹ç¢ºèªæ‰‹æ©ŸæœªéœéŸ³ / éŸ³é‡ä¸ç‚º 0</div>
</div>

<script>
/* ===== å¯æ”¹å€ ===== */
const prizes = [
  "ğŸ è«‹å¦³å–ä¸€æ¯",
  "ğŸ æŒ‡å®šä¸€å¤©é™ªå¦³",
  "ğŸ ç¥ç§˜é©šå–œ",
  "ğŸ˜ ï¼ˆä¸‹æ¬¡å†ä¾†ï¼‰",
  "ğŸ˜ ï¼ˆæ¸¬è©¦çå‹µï¼‰"
];

// ä½ çš„ Google Apps Script Web App URL
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwmK2iq0buMnVpxMPLJdd4yhOvpykvZ9nKv-9RUFBI-F3rMGtSELuYLLie4OjflhAnv/exec";
/* ===== å¯æ”¹å€çµæŸ ===== */

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;
const cx = W/2, cy = H/2;
const radius = Math.min(W,H)*0.46;

let rotation = 0;
let spinning = false;

function sliceColor(i, n){
  const hue = (i * (360/n)) % 360;
  return `hsl(${hue},70%,45%)`;
}

function drawWheel(rot){
  ctx.clearRect(0,0,W,H);
  const n = prizes.length;
  const arc = Math.PI*2/n;

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rot);

  for(let i=0;i<n;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,i*arc,(i+1)*arc);
    ctx.fillStyle = sliceColor(i,n);
    ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,.25)";
    ctx.lineWidth=6;
    ctx.stroke();

    ctx.save();
    ctx.rotate(i*arc+arc/2);
    ctx.textAlign="right";
    ctx.fillStyle="#fff";
    ctx.font="bold 28px system-ui";
    const label = prizes[i].length>16 ? prizes[i].slice(0,16)+"â€¦" : prizes[i];
    ctx.fillText(label,radius-20,10);
    ctx.restore();
  }
  ctx.restore();
}

drawWheel(0);

function pickIndex(rot){
  const arc = Math.PI*2/prizes.length;
  const a = ((-Math.PI/2 - rot) + Math.PI*2) % (Math.PI*2);
  return Math.floor(a/arc);
}

async function sendResult(data){
  if(!WEBHOOK_URL) return;

  const form = new URLSearchParams();
  form.append("prize", data.prize);
  form.append("index", data.index);
  form.append("time", data.time);
  form.append("ua", data.ua);

  try{
    await fetch(WEBHOOK_URL,{
      method:"POST",
      body:form
    });
  }catch(e){
    console.warn("send failed",e);
  }
}

const btn = document.getElementById("spinBtn");
const resultEl = document.getElementById("result");

btn.onclick = ()=>{
  if(spinning) return;
  spinning=true;
  btn.disabled=true;
  btn.textContent="æŠ½çä¸­â€¦";
  resultEl.style.display="none";

  const n = prizes.length;
  const arc = Math.PI*2/n;
  const target = Math.floor(Math.random()*n);
  const extra = 6+Math.random()*3;
  const targetRot = (-Math.PI/2-(target+0.5)*arc)+extra*Math.PI*2;
  const start = rotation;
  const delta = targetRot-start;
  const t0 = performance.now();

  function anim(t){
    const p = Math.min(1,(t-t0)/3000);
    rotation = start + delta*(1-Math.pow(1-p,3));
    drawWheel(rotation);
    if(p<1){
      requestAnimationFrame(anim);
    }else{
      spinning=false;
      const idx = pickIndex(rotation);
      const prize = prizes[idx];
      resultEl.textContent="âœ… ä½ æŠ½åˆ°ï¼š"+prize;
      resultEl.style.display="block";
      btn.disabled=false;
      btn.textContent="å†æŠ½ä¸€æ¬¡ï¼ˆä¸å»ºè­°å¤ªè²ªå¿ƒï¼‰";

      sendResult({
        prize,
        index: idx,
        time: new Date().toISOString(),
        ua: navigator.userAgent
      });
    }
  }
  requestAnimationFrame(anim);
};
</script>
</body>
</html>
